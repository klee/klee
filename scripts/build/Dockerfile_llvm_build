# Build LLVM
ARG REPOSITORY
FROM ${REPOSITORY}/base
LABEL maintainer="Martin Nowack <m.nowack@imperial.ac.uk>"

ENV DOCKER_BUILD=1

# Define all variables that can be changed as argument to the docker build
ARG BASE=/tmp
ARG DISABLE_ASSERTIONS
ARG ENABLE_OPTIMIZED
ARG ENABLE_DEBUG
ARG KLEE_TRAVIS_BUILD
ARG LLVM_SUFFIX
ARG LLVM_VERSION
ARG LLVM_VERSION_SHORT
ARG PACKAGED
ARG REQUIRES_RTTI
ARG SANITIZER_BUILD
ARG TRAVIS_OS_NAME
ARG LIB_CXX_MEMSAN_FOLDER

WORKDIR $BASE

# Copy across source files needed for build
ADD /scripts/build/patches scripts/build/patches
ADD /scripts/build/common-defaults.sh scripts/build/common-defaults.sh
ADD /scripts/build/common-functions scripts/build/common-functions
ADD /scripts/build/llvm.sh scripts/build/llvm.sh

RUN ./scripts/build/llvm.sh

#This prevents COPY from failing in builds without memsan
#Otherwise we would have to have different dockerfiles for memsan builds
RUN  mkdir -p "${BASE}/${LIB_CXX_MEMSAN_FOLDER}"
RUN  mkdir -p "${BASE}/llvm-${LLVM_VERSION_SHORT}-build${LLVM_SUFFIX}_libcxx"
