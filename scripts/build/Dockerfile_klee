ARG LLVM_SUFFIX
ARG LLVM_VERSION_SHORT
ARG REPOSITORY
ARG SOLVER_SUFFIX
ARG SANITIZER_SUFFIX
FROM ${REPOSITORY}/klee_deps:${LLVM_VERSION_SHORT}${LLVM_SUFFIX}${SANITIZER_SUFFIX} as llvmdeps

ARG REPOSITORY
ARG SOLVER_SUFFIX
FROM ${REPOSITORY}/solver:${SOLVER_SUFFIX}${SANITIZER_SUFFIX} as solver

ARG BASE=/tmp
#Remove all but the install dirs from the solver image, so that we can copy the whole
#${BASE}/ dir, because we don't know which solvers are there.
RUN bash -O extglob -c "rm -r !(*-install|metaSMT)"
#Create the dir so COPY does not fail if this image has no metaSMT
RUN mkdir -p ${BASE}/metaSMT

# Build the final KLEE layer
ARG REPOSITORY
FROM ${REPOSITORY}/base
LABEL maintainer="Martin Nowack <m.nowack@imperial.ac.uk>"

# Define all variables that can be changed as argument to the docker build
ARG BASE=/tmp
ARG COVERAGE=0
ARG DEPS_SUFFIX
ARG DISABLE_ASSERTIONS
ARG ENABLE_OPTIMIZED
ARG ENABLE_DEBUG
ARG KLEE_TRAVIS_BUILD
ARG KLEE_UCLIBC
ARG LLVM_VERSION_SHORT
ARG LLVM_VERSION
ARG LLVM_SUFFIX
ARG METASMT_BOOST_VERSION
ARG METASMT_DEFAULT
ARG METASMT_VERSION
ARG REQUIRES_RTTI
ARG SANITIZER_BUILD
ARG SANITIZER_SUFFIX
ARG SOLVER_SUFFIX
ARG SOLVERS
ARG STP_VERSION
ARG TRAVIS_OS_NAME
ARG USE_TCMALLOC
ARG Z3_VERSION
ARG REPOSITORY

ENV DOCKER_BUILD=1

# Copy across source files needed for build
ADD / ${BASE}/klee_src


#Copy in the llvm
COPY --from=llvmdeps ${BASE}/llvm-${LLVM_VERSION_SHORT}-install${LLVM_SUFFIX} ${BASE}/llvm-${LLVM_VERSION_SHORT}-install${LLVM_SUFFIX} 

COPY --from=llvmdeps ${BASE}/llvm-${LLVM_VERSION_SHORT}-build${LLVM_SUFFIX}_libcxx/ ${BASE}/llvm-${LLVM_VERSION_SHORT}-build${LLVM_SUFFIX}_libcxx/

#Copy in solvers
COPY --from=solver ${BASE}/ ${BASE}/

COPY --from=llvmdeps ${BASE}/tcmalloc-install ${BASE}/tcmalloc-install

COPY --from=llvmdeps ${BASE}/klee-uclibc-${LLVM_VERSION_SHORT} ${BASE}/klee-uclibc-${LLVM_VERSION_SHORT}

COPY --from=llvmdeps ${BASE}/gtest ${BASE}/gtest

# TODO Remove when STP is fixed
RUN export LD_LIBRARY_PATH=${BASE}/metaSMT/deps/stp-git-basic/lib/:${BASE}/minisat-install/lib && export KLEE_SRC=${BASE}/klee_src && ${BASE}/klee_src/scripts/build/klee.sh && rm -rf ${BASE}/klee_src/.git
