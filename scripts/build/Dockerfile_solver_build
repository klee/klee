ARG REPOSITORY
ARG LIB_CXX_MEMSAN_FOLDER_IMAGE 
FROM ${REPOSITORY}/${LIB_CXX_MEMSAN_FOLDER_IMAGE} as llvmcxx


ARG REPOSITORY
FROM ${REPOSITORY}/base
LABEL maintainer="Martin Nowack <m.nowack@imperial.ac.uk>"

ENV DOCKER_BUILD=1

# Define all variables that can be changed as argument to docker build
ARG BASE=/tmp
ARG KLEE_TRAVIS_BUILD
ARG METASMT_BOOST_VERSION
ARG METASMT_DEFAULT
ARG METASMT_VERSION
ARG REQUIRES_RTTI
ARG SOLVERS
ARG SANITIZER_BUILD
ARG STP_VERSION
ARG STORAGE_SPACE_OPTIMIZED=1
ARG TRAVIS_OS_NAME
ARG Z3_VERSION
ARG LIB_CXX_MEMSAN_FOLDER

WORKDIR $BASE

#This can be a fixed llvm version, because solvers can use their own stdlib, needs to be
#compiled with the same compiler probably. This is only needed for memsan builds.
COPY --from=llvmcxx ${BASE}/${LIB_CXX_MEMSAN_FOLDER}/ ${BASE}/${LIB_CXX_MEMSAN_FOLDER}/

#This ensure that we are indepedent of llvm in this dockerfile
ENV LLVM_VERSION=3.8
ENV ENABLE_OPTIMIZED=1
ENV ENABLE_DEBUG=0
ENV DISABLE_ASSERTIONS=0

# Copy across source files needed for build
ADD /scripts/build/common-defaults.sh scripts/build/common-defaults.sh
ADD /scripts/build/common-functions scripts/build/common-functions
ADD /scripts/build/solvers.sh scripts/build/solvers.sh
ADD /scripts/build/solver-stp.sh scripts/build/solver-stp.sh
ADD /scripts/build/solver-z3.sh scripts/build/solver-z3.sh
ADD /scripts/build/solver-metasmt.sh scripts/build/solver-metasmt.sh

RUN scripts/build/solvers.sh
